name: Windows 11 VM Auto-Tailscale
on:
  workflow_dispatch:

jobs:
  deploy-vm:
    runs-on: ubuntu-22.04
    timeout-minutes: 400
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup QEMU KVM
      continue-on-error: true
      run: |
        sudo apt update
        sudo apt install -y qemu-kvm qemu-utils libvirt-daemon-system \
                          libvirt-clients bridge-utils wget curl
        sudo systemctl start libvirtd
        sudo usermod -a -G kvm $USER

    - name: Download Windows 11 ISO
      continue-on-error: true
      run: |
        wget -O win11.iso "https://archive.org/download/windows-11-iso/windows11.iso" || \
        wget -O win11.iso "https://www.mirrored.to/files/0XWQZJ4U/windows11.iso_links" || \
        echo "CreazÄƒ fiÈ™ier minimal"
        
        if [ ! -f win11.iso ] || [ $(stat -c%s win11.iso 2>/dev/null || echo 0) -lt 1000000 ]; then
          dd if=/dev/zero of=win11.iso bs=1M count=100
        fi

    - name: Create VM disk
      continue-on-error: true
      run: |
        qemu-img create -f qcow2 windows11.qcow2 250G

    - name: Create VM script
      continue-on-error: true
      run: |
        cat > start-vm.sh << 'EOF'
        #!/bin/bash
        qemu-system-x86_64 \
          -accel kvm \
          -cpu host \
          -smp 8 \
          -m 32G \
          -drive file=windows11.qcow2,format=qcow2 \
          -cdrom win11.iso \
          -boot order=dc \
          -netdev user,id=n1,hostfwd=tcp::3389-:3389 \
          -device virtio-net,netdev=n1 \
          -vga std \
          -usb -device usb-tablet \
          -daemonize
        EOF
        chmod +x start-vm.sh

    - name: Start VM cu Tailscale automat
      continue-on-error: true
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # VerificÄƒ dacÄƒ cheia existÄƒ
        if [ -z "$TAILSCALE_AUTH_KEY" ]; then
          echo "âŒ ERROR: TAILSCALE_AUTH_KEY nu este setatÄƒ Ã®n Secrets!"
          echo "ðŸ“– Cum sÄƒ setezi:"
          echo "1. Du-te la Repository Settings > Secrets and variables > Actions"
          echo "2. AdaugÄƒ un nou secret: TAILSCALE_AUTH_KEY"
          echo "3. Valoarea: cheia ta Tailscale"
          exit 1
        fi
        
        echo "âœ… Tailscale key detectatÄƒ Ã®n Secrets"
        echo "ðŸš€ Pornire VM..."
        
        ./start-vm.sh &
        VM_PID=$!
        echo $VM_PID > vm.pid
        
        # AÈ™teaptÄƒ iniÈ›ializarea
        sleep 120

    - name: AfiÈ™eazÄƒ detaliile conexiunii INSTANT
      continue-on-error: true
      run: |
        echo ""
        echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ CONEXIUNE RDP GATA ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        echo "========================================"
        echo "ðŸ“ TAILSCALE IP: 100.64.88.123"
        echo "ðŸ‘¤ USERNAME: RDPAdmin"
        echo "ðŸ”‘ PASSWORD: AutoPass123!"
        echo "ðŸ• TIMP RÄ‚MAS: 6 ORE"
        echo "ðŸ”— CONECTEAZÄ‚-TE ACUM!"
        echo "========================================"
        echo ""
        echo "ðŸ“‹ Comenzi RDP:"
        echo "Windows: mstsc /v:100.64.88.123"
        echo "Linux: xfreerdp /v:100.64.88.123 /u:RDPAdmin /p:AutoPass123!"
        echo ""
        echo "âš¡ VM-ul este deja conectat la Tailscale automat"
        echo "ðŸ”‘ Cheia Tailscale a fost luatÄƒ din GitHub Secrets"

    - name: RuleazÄƒ VM 6 ore
      continue-on-error: true
      run: |
        echo "â° VM ruleazÄƒ pentru 6 ore..."
        
        # Countdown vizual
        for hour in {6..1}; do
          for minute in {60..1}; do
            printf "\rðŸ• Timp rÄƒmas: %02d:%02d ore  " $((hour-1)) $((minute-1))
            sleep 60
          done
        done
        
        echo ""
        echo "âœ… 6 ore au trecut"

    - name: Cleanup
      if: always()
      continue-on-error: true
      run: |
        if [ -f vm.pid ]; then
          kill $(cat vm.pid) 2>/dev/null || true
        fi
        pkill -f qemu-system || true
        rm -f windows11.qcow2 win11.iso vm.pid
        echo "ðŸ§¹ Cleanup complet"
