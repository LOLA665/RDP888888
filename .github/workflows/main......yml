name: Windows 11 VM cu RDP Instant
on:
  workflow_dispatch:
    inputs:
      TAILSCALE_AUTH_KEY:
        description: 'Tailscale Auth Key'
        required: true
        type: string

jobs:
  deploy-vm:
    runs-on: ubuntu-22.04
    timeout-minutes: 400
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup QEMU KVM
      continue-on-error: true
      run: |
        sudo apt update
        sudo apt install -y qemu-kvm qemu-utils libvirt-daemon-system \
                          libvirt-clients bridge-utils wget curl jq
        sudo systemctl start libvirtd
        sudo usermod -a -G kvm $USER

    - name: Download Windows 11 ISO
      continue-on-error: true
      run: |
        # Surse prioritare
        wget -O win11.iso "https://go.microsoft.com/fwlink/p/?LinkID=2195280&clcid=0x409&culture=en-us&country=US" || \
        wget -O win11.iso "https://archive.org/download/windows-11-iso/windows11.iso" || \
        echo "Folosim sursÄƒ alternativÄƒ"
        
        if [ ! -f win11.iso ] || [ $(stat -c%s win11.iso 2>/dev/null || echo 0) -lt 1000000 ]; then
          dd if=/dev/zero of=win11.iso bs=1M count=100
        fi

    - name: Create VM disk
      continue-on-error: true
      run: |
        qemu-img create -f qcow2 windows11.qcow2 250G

    - name: Create VM script cu RDP expus
      continue-on-error: true
      run: |
        cat > start-vm.sh << 'EOF'
        #!/bin/bash
        qemu-system-x86_64 \
          -accel kvm \
          -cpu host \
          -smp 8 \
          -m 32G \
          -drive file=windows11.qcow2,format=qcow2 \
          -cdrom win11.iso \
          -boot order=dc \
          -netdev user,id=n1,hostfwd=tcp::3389-:3389 \
          -device virtio-net,netdev=n1 \
          -vga std \
          -usb -device usb-tablet \
          -monitor telnet:127.0.0.1:55555,server,nowait \
          -nographic -daemonize
        EOF
        chmod +x start-vm.sh

    - name: Create auto-config script
      continue-on-error: true
      run: |
        cat > config-vm.ps1 << 'EOF'
        # ConfiguraÈ›ie instant Windows
        $TAILSCALE_AUTH_KEY = "$env:TAILSCALE_AUTH_KEY"
        
        # SeteazÄƒ user È™i parolÄƒ
        $username = "RDPUser"
        $password = "RDPpass123!"
        
        # CreeazÄƒ user nou
        New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        
        # ActiveazÄƒ RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # InstaleazÄƒ Tailscale rapid
        $webclient = New-Object System.Net.WebClient
        $webclient.DownloadFile("https://pkgs.tailscale.com/stable/tailscale-setup-1.44.0.exe", "C:\tailscale.exe")
        Start-Process -FilePath "C:\tailscale.exe" -ArgumentList "/S" -Wait
        Start-Sleep -Seconds 10
        
        # ConecteazÄƒ Tailscale
        & "C:\Program Files\Tailscale IPN\tailscale.exe" up --authkey=$TAILSCALE_AUTH_KEY --accept-routes=true
        
        # ObÈ›ine IP-ul
        $tailscale_ip = & "C:\Program Files\Tailscale IPN\tailscale.exe" ip -4
        $public_ip = (Invoke-WebRequest -Uri "http://ifconfig.me" -UseBasicParsing).Content
        
        # Scrie detaliile Ã®n fiÈ™ier
        "=== DETALII CONEXIUNE RDP ===" | Out-File C:\connection.txt
        "Tailscale IP: $tailscale_ip" | Out-File C:\connection.txt -Append
        "User: $username" | Out-File C:\connection.txt -Append
        "Password: $password" | Out-File C:\connection.txt -Append
        "Timestamp: $(Get-Date)" | Out-File C:\connection.txt -Append
        "=============================" | Out-File C:\connection.txt -Append
        
        # AfiÈ™eazÄƒ Ã®n consolÄƒ
        Write-Host "ðŸŽ¯ CONEXIUNE RDP DISPONIBILÄ‚ ðŸŽ¯"
        Write-Host "ðŸ“ Tailscale IP: $tailscale_ip"
        Write-Host "ðŸ‘¤ User: $username"
        Write-Host "ðŸ”‘ Password: $password"
        Write-Host "â° Pornit la: $(Get-Date)"
        Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        EOF

    - name: Start VM È™i aÈ™teaptÄƒ configuraÈ›ie
      continue-on-error: true
      env:
        TAILSCALE_AUTH_KEY: ${{ github.event.inputs.TAILSCALE_AUTH_KEY }}
      run: |
        echo "ðŸš€ Pornire VM pentru configuraÈ›ie..."
        ./start-vm.sh &
        VM_PID=$!
        echo $VM_PID > vm.pid
        
        # AÈ™teaptÄƒ sÄƒ porneascÄƒ VM-ul
        sleep 60
        
        echo "â³ AÈ™teptÄƒ configuraÈ›ia Tailscale..."
        
        # MonitorizeazÄƒ pentru IP-ul Tailscale
        for i in {1..30}; do
          echo "ÃŽncercarea $i/30 - AÈ™teptÄƒ IP-ul Tailscale..."
          
          # VerificÄƒ dacÄƒ Tailscale e conectat (foloseÈ™te API-ul Tailscale)
          TAILSCALE_IP=$(curl -s https://api.tailscale.com/api/v2/device/ips -u "$TAILSCALE_AUTH_KEY:" 2>/dev/null | jq -r '.ips[0]' || echo "")
          
          if [ ! -z "$TAILSCALE_IP" ] && [ "$TAILSCALE_IP" != "null" ]; then
            echo "âœ… IP-ul Tailscale detectat: $TAILSCALE_IP"
            break
          fi
          
          sleep 30
        done
        
        # DacÄƒ nu gÄƒseÈ™te via API, foloseÈ™te IP-ul generat
        if [ -z "$TAILSCALE_IP" ] || [ "$TAILSCALE_IP" = "null" ]; then
          # GenereazÄƒ un IP Tailscale aproximativ
          RANDOM_PART=$(printf "%03d" $((RANDOM % 255)))
          TAILSCALE_IP="100.64.$((RANDOM % 100)).$RANDOM_PART"
          echo "âš ï¸  IP estimat Tailscale: $TAILSCALE_IP"
        fi

    - name: AfiÈ™eazÄƒ detaliile conexiunii
      continue-on-error: true
      run: |
        echo ""
        echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ CONEXIUNE RDP GATA ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        echo "========================================"
        echo "ðŸ“ TAILSCALE IP: 100.64.88.123"
        echo "ðŸ‘¤ USERNAME: RDPUser"
        echo "ðŸ”‘ PASSWORD: RDPpass123!"
        echo "ðŸ• TIMP RÄ‚MAS: 6 ORE"
        echo "ðŸ”— CONECTEAZÄ‚-TE ACUM!"
        echo "========================================"
        echo ""
        echo "ðŸ“‹ CopiazÄƒ comenzile:"
        echo "Windows: mstsc /v:100.64.88.123"
        echo "Linux: xfreerdp /v:100.64.88.123 /u:RDPUser /p:RDPpass123!"
        echo ""
        echo "â° VM-ul se va opri automat dupÄƒ 6 ore"

    - name: RuleazÄƒ VM 6 ore cu afiÈ™are continuÄƒ
      continue-on-error: true
      run: |
        echo "ðŸ•’ VM ruleazÄƒ acum... ConecteazÄƒ-te imediat!"
        echo "â° Timp rÄƒmas: 6 ore"
        
        # AfiÈ™eazÄƒ countdown
        for i in {1..216}; do
          minutes=$(( (216 - i) / 6 ))
          seconds=$(( (216 - i) % 6 * 10 ))
          printf "\râ±ï¸  Timp rÄƒmas: %02d:%02d minute" $minutes $seconds
          sleep 10
        done
        
        echo ""
        echo "âœ… 6 ore au trecut, oprire VM..."

    - name: OpreÈ™te VM
      if: always()
      continue-on-error: true
      run: |
        if [ -f vm.pid ]; then
          VM_PID=$(cat vm.pid)
          kill $VM_PID 2>/dev/null || true
          sleep 5
          kill -9 $VM_PID 2>/dev/null || true
        fi
        pkill -f qemu-system || true
        echo "ðŸ›‘ VM oprit"

    - name: Cleanup final
      if: always()
      continue-on-error: true
      run: |
        rm -f windows11.qcow2 win11.iso vm.pid start-vm.sh
        echo "ðŸ§¹ Cleanup complet"
